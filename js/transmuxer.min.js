(function(z){var B=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],C=[44100,48E3,32E3,22050,24E3,16E3,11025,12E3,8E3],D=function(){function e(){this.buffer=null;this.bufferSize=0}e.prototype.push=function(e){if(0<this.bufferSize){var f=e.length+this.bufferSize;if(!this.buffer||this.buffer.length<f){var r=
new Uint8Array(f);0<this.bufferSize&&r.set(this.buffer.subarray(0,this.bufferSize));this.buffer=r}this.buffer.set(e,this.bufferSize);this.bufferSize=f;e=this.buffer}else f=e.length;r=0;for(var k;r<f&&0<(k=this._parse(e,r,f));)r+=k;k=f-r;0<k&&(!this.buffer||this.buffer.length<k?this.buffer=new Uint8Array(e.subarray(r,f)):this.buffer.set(e.subarray(r,f)));this.bufferSize=k};e.prototype._parse=function(e,f,r){if(f+2>r)return-1;if(255===e[f]||224===(e[f+1]&224)){if(f+24>r)return-1;var k=e[f+1]>>3&3,h=
e[f+1]>>1&3,n=e[f+2]>>4&15,q=e[f+2]>>2&3,p=!!(e[f+2]&2);if(1!==k&&0!==n&&15!==n&&3!==q){n=1E3*B[14*(3===k?3-h:3===h?3:4)+n-1];q=C[3*(3===k?0:2===k?1:2)+q];p=p?1:0;k=3===h?(3===k?12:6)*n/q+p<<2:(3===k?144:72)*n/q+p|0;if(f+k>r)return-1;this.onFrame&&(this.samplerate||(this.samplerate=q),this.onFrame(e.subarray(f,f+k)));return k}}for(k=f+2;k<r;){if(255===e[k-1]&&224===(e[k]&224)){if(this.onNoise)this.onNoise(e.subarray(f,k-1));return k-f-1}k++}return-1};e.prototype.close=function(){if(0<this.bufferSize&&
this.onNoise)this.onNoise(this.buffer.subarray(0,this.bufferSize));this.buffer=null;this.bufferSize=0;if(this.onClose)this.onClose()};return e}(),e=function(){function e(d){for(var c=new Uint8Array(4*d.length),a=0,b=0,f=d.length;b<f;b++){var e=d.charCodeAt(b);if(127>=e)c[a++]=e;else{if(55296<=e&&56319>=e){var g=d.charCodeAt(b+1);56320<=g&&57343>=g&&(e=((e&1023)<<10)+(g&1023)+65536,++b)}0!==(e&4292870144)?(c[a++]=248|e>>>24&3,c[a++]=128|e>>>18&63,c[a++]=128|e>>>12&63,c[a++]=128|e>>>6&63):0!==(e&4294901760)?
(c[a++]=240|e>>>18&7,c[a++]=128|e>>>12&63,c[a++]=128|e>>>6&63):0!==(e&4294965248)?(c[a++]=224|e>>>12&15,c[a++]=128|e>>>6&63):c[a++]=192|e>>>6&31;c[a++]=128|e&63}}return c.subarray(0,a)}function w(d){for(var c=[],a=1;a<arguments.length;a++)c[a-1]=arguments[a];return Array.prototype.concat.apply(d,c)}function f(d,c,a){d[c]=a>>24&255;d[c+1]=a>>16&255;d[c+2]=a>>8&255;d[c+3]=a&255}function r(d){return d.charCodeAt(0)<<24|d.charCodeAt(1)<<16|d.charCodeAt(2)<<8|d.charCodeAt(3)}var k=this&&this.__extends||
function(d,c){function a(){this.constructor=d}for(var b in c)c.hasOwnProperty(b)&&(d[b]=c[b]);d.prototype=null===c?Object.create(c):(a.prototype=c.prototype,new a)},h={},u=[1,0,0,0,1,0,0,0,1],q=[0,0,0],p=function(){function d(d,a){this.boxtype=d;"uuid"===d&&(this.userType=a)}d.prototype.layout=function(d){this.offset=d;d=8;this.userType&&(d+=16);return this.size=d};d.prototype.write=function(d){f(d,this.offset,this.size);f(d,this.offset+4,r(this.boxtype));if(!this.userType)return 8;d.set(this.userType,
this.offset+8);return 24};d.prototype.toUint8Array=function(){var d=this.layout(0);d=new Uint8Array(d);this.write(d);return d};return d}();h.Box=p;var l=function(d){function c(a,b,c){void 0===b&&(b=0);void 0===c&&(c=0);d.call(this,a);this.version=b;this.flags=c}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+4};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,this.version<<24|this.flags);return b+4};return c}(p);h.FullBox=
l;var m=function(d){function c(a,b,c){d.call(this,"ftype");this.majorBrand=a;this.minorVersion=b;this.compatibleBrands=c}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+4*(2+this.compatibleBrands.length)};c.prototype.write=function(a){var b=this,c=d.prototype.write.call(this,a);f(a,this.offset+c,r(this.majorBrand));f(a,this.offset+c+4,this.minorVersion);c+=8;this.compatibleBrands.forEach(function(d){f(a,b.offset+c,r(d));c+=4},this);return c};return c}(p);h.FileTypeBox=
m;m=function(d){function c(a,b){d.call(this,a);this.children=b}k(c,d);c.prototype.layout=function(a){var b=d.prototype.layout.call(this,a);this.children.forEach(function(d){d&&(b+=d.layout(a+b))});return this.size=b};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);this.children.forEach(function(d){d&&(b+=d.write(a))});return b};return c}(p);h.BoxContainerBox=m;var g=function(d){function c(a,b,c,f){d.call(this,"moov",w([a],b,[c,f]));this.header=a;this.tracks=b;this.extendsBox=c;
this.userData=f}k(c,d);return c}(m);h.MovieBox=g;g=function(d){function c(a,b,c,f,e,g,l,m){void 0===f&&(f=1);void 0===e&&(e=1);void 0===g&&(g=u);void 0===l&&(l=-20828448E5);void 0===m&&(m=-20828448E5);d.call(this,"mvhd",0,0);this.timescale=a;this.duration=b;this.nextTrackId=c;this.rate=f;this.volume=e;this.matrix=g;this.creationTime=l;this.modificationTime=m}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+16+4+2+2+8+36+24+4};c.prototype.write=function(a){var b=
d.prototype.write.call(this,a);f(a,this.offset+b,(this.creationTime- -20828448E5)/1E3|0);f(a,this.offset+b+4,(this.modificationTime- -20828448E5)/1E3|0);f(a,this.offset+b+8,this.timescale);f(a,this.offset+b+12,this.duration);b+=16;f(a,this.offset+b,65536*this.rate|0);f(a,this.offset+b+4,(256*this.volume|0)<<16);f(a,this.offset+b+8,0);f(a,this.offset+b+12,0);b+=16;f(a,this.offset+b,65536*this.matrix[0]|0);f(a,this.offset+b+4,65536*this.matrix[1]|0);f(a,this.offset+b+8,65536*this.matrix[2]|0);f(a,this.offset+
b+12,65536*this.matrix[3]|0);f(a,this.offset+b+16,65536*this.matrix[4]|0);f(a,this.offset+b+20,65536*this.matrix[5]|0);f(a,this.offset+b+24,1073741824*this.matrix[6]|0);f(a,this.offset+b+28,1073741824*this.matrix[7]|0);f(a,this.offset+b+32,1073741824*this.matrix[8]|0);b+=36;f(a,this.offset+b,0);f(a,this.offset+b+4,0);f(a,this.offset+b+8,0);f(a,this.offset+b+12,0);f(a,this.offset+b+16,0);f(a,this.offset+b+20,0);b+=24;f(a,this.offset+b,this.nextTrackId);return b+4};return c}(l);h.MovieHeaderBox=g;(function(d){d[d.TRACK_ENABLED=
1]="TRACK_ENABLED";d[d.TRACK_IN_MOVIE=2]="TRACK_IN_MOVIE";d[d.TRACK_IN_PREVIEW=4]="TRACK_IN_PREVIEW"})(h.TrackHeaderFlags||(h.TrackHeaderFlags={}));g=function(d){function c(a,b,c,f,e,g,l,m,k,h,t){void 0===l&&(l=0);void 0===m&&(m=0);void 0===k&&(k=u);void 0===h&&(h=-20828448E5);void 0===t&&(t=-20828448E5);d.call(this,"tkhd",0,a);this.trackId=b;this.duration=c;this.width=f;this.height=e;this.volume=g;this.alternateGroup=l;this.layer=m;this.matrix=k;this.creationTime=h;this.modificationTime=t}k(c,d);
c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+20+8+6+2+36+8};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,(this.creationTime- -20828448E5)/1E3|0);f(a,this.offset+b+4,(this.modificationTime- -20828448E5)/1E3|0);f(a,this.offset+b+8,this.trackId);f(a,this.offset+b+12,0);f(a,this.offset+b+16,this.duration);b+=20;f(a,this.offset+b,0);f(a,this.offset+b+4,0);f(a,this.offset+b+8,this.layer<<16|this.alternateGroup);f(a,this.offset+b+
12,(256*this.volume|0)<<16);b+=16;f(a,this.offset+b,65536*this.matrix[0]|0);f(a,this.offset+b+4,65536*this.matrix[1]|0);f(a,this.offset+b+8,65536*this.matrix[2]|0);f(a,this.offset+b+12,65536*this.matrix[3]|0);f(a,this.offset+b+16,65536*this.matrix[4]|0);f(a,this.offset+b+20,65536*this.matrix[5]|0);f(a,this.offset+b+24,1073741824*this.matrix[6]|0);f(a,this.offset+b+28,1073741824*this.matrix[7]|0);f(a,this.offset+b+32,1073741824*this.matrix[8]|0);b+=36;f(a,this.offset+b,65536*this.width|0);f(a,this.offset+
b+4,65536*this.height|0);return b+8};return c}(l);h.TrackHeaderBox=g;g=function(d){function c(a,b,c,f,e){void 0===c&&(c="unk");void 0===f&&(f=-20828448E5);void 0===e&&(e=-20828448E5);d.call(this,"mdhd",0,0);this.timescale=a;this.duration=b;this.language=c;this.creationTime=f;this.modificationTime=e}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+16+4};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,(this.creationTime- -20828448E5)/
1E3|0);f(a,this.offset+b+4,(this.modificationTime- -20828448E5)/1E3|0);f(a,this.offset+b+8,this.timescale);f(a,this.offset+b+12,this.duration);var c=this.offset+b+16;var e=this.language;e=(e.charCodeAt(0)&31)<<10|(e.charCodeAt(1)&31)<<5|e.charCodeAt(2)&31;f(a,c,e<<16);return b+20};return c}(l);h.MediaHeaderBox=g;g=function(d){function c(a,b){d.call(this,"hdlr",0,0);this.handlerType=a;this.name=b;this._encodedName=e(this.name)}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,
a)+8+12+(this._encodedName.length+1)};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,0);f(a,this.offset+b+4,r(this.handlerType));f(a,this.offset+b+8,0);f(a,this.offset+b+12,0);f(a,this.offset+b+16,0);b+=20;a.set(this._encodedName,this.offset+b);a[this.offset+b+this._encodedName.length]=0;return b+=this._encodedName.length+1};return c}(l);h.HandlerBox=g;g=function(d){function c(a){void 0===a&&(a=0);d.call(this,"smhd",0,0);this.balance=a}k(c,d);c.prototype.layout=
function(a){return this.size=d.prototype.layout.call(this,a)+4};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,(256*this.balance|0)<<16);return b+4};return c}(l);h.SoundMediaHeaderBox=g;g=function(d){function c(a,b){void 0===a&&(a=0);void 0===b&&(b=q);d.call(this,"vmhd",0,0);this.graphicsMode=a;this.opColor=b}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+8};c.prototype.write=function(a){var b=d.prototype.write.call(this,
a);f(a,this.offset+b,this.graphicsMode<<16|this.opColor[0]);f(a,this.offset+b+4,this.opColor[1]<<16|this.opColor[2]);return b+8};return c}(l);h.VideoMediaHeaderBox=g;h.SELF_CONTAINED_DATA_REFERENCE_FLAG=1;g=function(d){function c(a,b){void 0===b&&(b=null);d.call(this,"url ",0,a);this.location=b;a&h.SELF_CONTAINED_DATA_REFERENCE_FLAG||(this._encodedLocation=e(b))}k(c,d);c.prototype.layout=function(a){a=d.prototype.layout.call(this,a);this._encodedLocation&&(a+=this._encodedLocation.length+1);return this.size=
a};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);this._encodedLocation&&(a.set(this._encodedLocation,this.offset+b),a[this.offset+b+this._encodedLocation.length]=0,b+=this._encodedLocation.length);return b};return c}(l);h.DataEntryUrlBox=g;g=function(d){function c(a){d.call(this,"dref",0,0);this.entries=a}k(c,d);c.prototype.layout=function(a){var b=d.prototype.layout.call(this,a)+4;this.entries.forEach(function(d){b+=d.layout(a+b)});return this.size=b};c.prototype.write=function(a){var b=
d.prototype.write.call(this,a);f(a,this.offset+b,this.entries.length);this.entries.forEach(function(d){b+=d.write(a)});return b};return c}(l);h.DataReferenceBox=g;g=function(d){function c(a){d.call(this,"dinf",[a]);this.dataReference=a}k(c,d);return c}(m);h.DataInformationBox=g;g=function(d){function c(a){d.call(this,"stsd",0,0);this.entries=a}k(c,d);c.prototype.layout=function(a){var b=d.prototype.layout.call(this,a);b+=4;this.entries.forEach(function(d){b+=d.layout(a+b)});return this.size=b};c.prototype.write=
function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,this.entries.length);b+=4;this.entries.forEach(function(d){b+=d.write(a)});return b};return c}(l);h.SampleDescriptionBox=g;g=function(d){function c(a,b,c,f,e){d.call(this,"stbl",[a,b,c,f,e]);this.sampleDescriptions=a;this.timeToSample=b;this.sampleToChunk=c;this.sampleSizes=f;this.chunkOffset=e}k(c,d);return c}(m);h.SampleTableBox=g;g=function(d){function c(a,b,c){d.call(this,"minf",[a,b,c]);this.header=a;this.info=b;this.sampleTable=
c}k(c,d);return c}(m);h.MediaInformationBox=g;g=function(d){function c(a,b,c){d.call(this,"mdia",[a,b,c]);this.header=a;this.handler=b;this.info=c}k(c,d);return c}(m);h.MediaBox=g;g=function(d){function c(a,b){d.call(this,"trak",[a,b]);this.header=a;this.media=b}k(c,d);return c}(m);h.TrackBox=g;g=function(d){function c(a,b,c,f,e){d.call(this,"trex",0,0);this.trackId=a;this.defaultSampleDescriptionIndex=b;this.defaultSampleDuration=c;this.defaultSampleSize=f;this.defaultSampleFlags=e}k(c,d);c.prototype.layout=
function(a){return this.size=d.prototype.layout.call(this,a)+20};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,this.trackId);f(a,this.offset+b+4,this.defaultSampleDescriptionIndex);f(a,this.offset+b+8,this.defaultSampleDuration);f(a,this.offset+b+12,this.defaultSampleSize);f(a,this.offset+b+16,this.defaultSampleFlags);return b+20};return c}(l);h.TrackExtendsBox=g;g=function(d){function c(a,b,c){d.call(this,"mvex",w([a],b,[c]));this.header=a;this.tracDefaults=
b;this.levels=c}k(c,d);return c}(m);h.MovieExtendsBox=g;g=function(d){function c(a,b){d.call(this,"meta",0,0);this.handler=a;this.otherBoxes=b}k(c,d);c.prototype.layout=function(a){var b=d.prototype.layout.call(this,a);b+=this.handler.layout(a+b);this.otherBoxes.forEach(function(d){b+=d.layout(a+b)});return this.size=b};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);b+=this.handler.write(a);this.otherBoxes.forEach(function(d){b+=d.write(a)});return b};return c}(l);h.MetaBox=g;
g=function(d){function c(a){d.call(this,"mfhd",0,0);this.sequenceNumber=a}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+4};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,this.sequenceNumber);return b+4};return c}(l);h.MovieFragmentHeaderBox=g;(function(d){d[d.BASE_DATA_OFFSET_PRESENT=1]="BASE_DATA_OFFSET_PRESENT";d[d.SAMPLE_DESCRIPTION_INDEX_PRESENT=2]="SAMPLE_DESCRIPTION_INDEX_PRESENT";d[d.DEFAULT_SAMPLE_DURATION_PRESENT=
8]="DEFAULT_SAMPLE_DURATION_PRESENT";d[d.DEFAULT_SAMPLE_SIZE_PRESENT=16]="DEFAULT_SAMPLE_SIZE_PRESENT";d[d.DEFAULT_SAMPLE_FLAGS_PRESENT=32]="DEFAULT_SAMPLE_FLAGS_PRESENT"})(h.TrackFragmentFlags||(h.TrackFragmentFlags={}));var t=h.TrackFragmentFlags;g=function(d){function c(a,b,c,f,e,g,l){d.call(this,"tfhd",0,a);this.trackId=b;this.baseDataOffset=c;this.sampleDescriptionIndex=f;this.defaultSampleDuration=e;this.defaultSampleSize=g;this.defaultSampleFlags=l}k(c,d);c.prototype.layout=function(a){a=d.prototype.layout.call(this,
a)+4;var b=this.flags;b&t.BASE_DATA_OFFSET_PRESENT&&(a+=8);b&t.SAMPLE_DESCRIPTION_INDEX_PRESENT&&(a+=4);b&t.DEFAULT_SAMPLE_DURATION_PRESENT&&(a+=4);b&t.DEFAULT_SAMPLE_SIZE_PRESENT&&(a+=4);b&t.DEFAULT_SAMPLE_FLAGS_PRESENT&&(a+=4);return this.size=a};c.prototype.write=function(a){var b=d.prototype.write.call(this,a),c=this.flags;f(a,this.offset+b,this.trackId);b+=4;c&t.BASE_DATA_OFFSET_PRESENT&&(f(a,this.offset+b,0),f(a,this.offset+b+4,this.baseDataOffset),b+=8);c&t.SAMPLE_DESCRIPTION_INDEX_PRESENT&&
(f(a,this.offset+b,this.sampleDescriptionIndex),b+=4);c&t.DEFAULT_SAMPLE_DURATION_PRESENT&&(f(a,this.offset+b,this.defaultSampleDuration),b+=4);c&t.DEFAULT_SAMPLE_SIZE_PRESENT&&(f(a,this.offset+b,this.defaultSampleSize),b+=4);c&t.DEFAULT_SAMPLE_FLAGS_PRESENT&&(f(a,this.offset+b,this.defaultSampleFlags),b+=4);return b};return c}(l);h.TrackFragmentHeaderBox=g;g=function(d){function c(a){d.call(this,"tfdt",0,0);this.baseMediaDecodeTime=a}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,
a)+4};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,this.baseMediaDecodeTime);return b+4};return c}(l);h.TrackFragmentBaseMediaDecodeTimeBox=g;g=function(d){function c(a,b,c){d.call(this,"traf",[a,b,c]);this.header=a;this.decodeTime=b;this.run=c}k(c,d);return c}(m);h.TrackFragmentBox=g;(function(d){d[d.IS_LEADING_MASK=201326592]="IS_LEADING_MASK";d[d.SAMPLE_DEPENDS_ON_MASK=50331648]="SAMPLE_DEPENDS_ON_MASK";d[d.SAMPLE_DEPENDS_ON_OTHER=16777216]="SAMPLE_DEPENDS_ON_OTHER";
d[d.SAMPLE_DEPENDS_ON_NO_OTHERS=33554432]="SAMPLE_DEPENDS_ON_NO_OTHERS";d[d.SAMPLE_IS_DEPENDED_ON_MASK=12582912]="SAMPLE_IS_DEPENDED_ON_MASK";d[d.SAMPLE_HAS_REDUNDANCY_MASK=3145728]="SAMPLE_HAS_REDUNDANCY_MASK";d[d.SAMPLE_PADDING_VALUE_MASK=917504]="SAMPLE_PADDING_VALUE_MASK";d[d.SAMPLE_IS_NOT_SYNC=65536]="SAMPLE_IS_NOT_SYNC";d[d.SAMPLE_DEGRADATION_PRIORITY_MASK=65535]="SAMPLE_DEGRADATION_PRIORITY_MASK"})(h.SampleFlags||(h.SampleFlags={}));(function(d){d[d.DATA_OFFSET_PRESENT=1]="DATA_OFFSET_PRESENT";
d[d.FIRST_SAMPLE_FLAGS_PRESENT=4]="FIRST_SAMPLE_FLAGS_PRESENT";d[d.SAMPLE_DURATION_PRESENT=256]="SAMPLE_DURATION_PRESENT";d[d.SAMPLE_SIZE_PRESENT=512]="SAMPLE_SIZE_PRESENT";d[d.SAMPLE_FLAGS_PRESENT=1024]="SAMPLE_FLAGS_PRESENT";d[d.SAMPLE_COMPOSITION_TIME_OFFSET=2048]="SAMPLE_COMPOSITION_TIME_OFFSET"})(h.TrackRunFlags||(h.TrackRunFlags={}));var v=h.TrackRunFlags;l=function(d){function c(a,b,c,f){d.call(this,"trun",1,a);this.samples=b;this.dataOffset=c;this.firstSampleFlags=f}k(c,d);c.prototype.layout=
function(a){a=d.prototype.layout.call(this,a)+4;var b=this.samples.length,c=this.flags;c&v.DATA_OFFSET_PRESENT&&(a+=4);c&v.FIRST_SAMPLE_FLAGS_PRESENT&&(a+=4);c&v.SAMPLE_DURATION_PRESENT&&(a+=4*b);c&v.SAMPLE_SIZE_PRESENT&&(a+=4*b);c&v.SAMPLE_FLAGS_PRESENT&&(a+=4*b);c&v.SAMPLE_COMPOSITION_TIME_OFFSET&&(a+=4*b);return this.size=a};c.prototype.write=function(a){var b=d.prototype.write.call(this,a),c=this.samples.length,e=this.flags;f(a,this.offset+b,c);b+=4;e&v.DATA_OFFSET_PRESENT&&(f(a,this.offset+b,
this.dataOffset),b+=4);e&v.FIRST_SAMPLE_FLAGS_PRESENT&&(f(a,this.offset+b,this.firstSampleFlags),b+=4);for(var g=0;g<c;g++){var l=this.samples[g];e&v.SAMPLE_DURATION_PRESENT&&(f(a,this.offset+b,l.duration),b+=4);e&v.SAMPLE_SIZE_PRESENT&&(f(a,this.offset+b,l.size),b+=4);e&v.SAMPLE_FLAGS_PRESENT&&(f(a,this.offset+b,l.flags),b+=4);e&v.SAMPLE_COMPOSITION_TIME_OFFSET&&(f(a,this.offset+b,l.compositionTimeOffset),b+=4)}return b};return c}(l);h.TrackRunBox=l;l=function(d){function c(a,b){d.call(this,"moof",
w([a],b));this.header=a;this.trafs=b}k(c,d);return c}(m);h.MovieFragmentBox=l;l=function(d){function c(a){d.call(this,"mdat");this.chunks=a}k(c,d);c.prototype.layout=function(a){var b=d.prototype.layout.call(this,a);this.chunks.forEach(function(a){b+=a.length});return this.size=b};c.prototype.write=function(a){var b=this,c=d.prototype.write.call(this,a);this.chunks.forEach(function(d){a.set(d,b.offset+c);c+=d.length},this);return c};return c}(p);h.MediaDataBox=l;l=function(d){function c(a,b){d.call(this,
a);this.dataReferenceIndex=b}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+8};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,0);f(a,this.offset+b+4,this.dataReferenceIndex);return b+8};return c}(p);h.SampleEntry=l;m=function(d){function c(a,b,c,f,e,g){void 0===c&&(c=2);void 0===f&&(f=16);void 0===e&&(e=44100);void 0===g&&(g=null);d.call(this,a,b);this.channelCount=c;this.sampleSize=f;this.sampleRate=e;this.otherBoxes=g}
k(c,d);c.prototype.layout=function(a){var b=d.prototype.layout.call(this,a)+20;this.otherBoxes&&this.otherBoxes.forEach(function(d){b+=d.layout(a+b)});return this.size=b};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,0);f(a,this.offset+b+4,0);f(a,this.offset+b+8,this.channelCount<<16|this.sampleSize);f(a,this.offset+b+12,0);f(a,this.offset+b+16,this.sampleRate<<16);b+=20;this.otherBoxes&&this.otherBoxes.forEach(function(d){b+=d.write(a)});return b};return c}(l);
h.AudioSampleEntry=m;h.COLOR_NO_ALPHA_VIDEO_SAMPLE_DEPTH=24;l=function(d){function c(a,b,c,f,e,g,l,m,k,t){void 0===e&&(e="");void 0===g&&(g=72);void 0===l&&(l=72);void 0===m&&(m=1);void 0===k&&(k=h.COLOR_NO_ALPHA_VIDEO_SAMPLE_DEPTH);void 0===t&&(t=null);d.call(this,a,b);this.width=c;this.height=f;this.compressorName=e;this.horizResolution=g;this.vertResolution=l;this.frameCount=m;this.depth=k;this.otherBoxes=t;if(31<e.length)throw Error("invalid compressor name");}k(c,d);c.prototype.layout=function(a){var b=
d.prototype.layout.call(this,a)+16+12+4+2+32+2+2;this.otherBoxes&&this.otherBoxes.forEach(function(d){b+=d.layout(a+b)});return this.size=b};c.prototype.write=function(a){var b=d.prototype.write.call(this,a);f(a,this.offset+b,0);f(a,this.offset+b+4,0);f(a,this.offset+b+8,0);f(a,this.offset+b+12,0);b+=16;f(a,this.offset+b,this.width<<16|this.height);f(a,this.offset+b+4,65536*this.horizResolution|0);f(a,this.offset+b+8,65536*this.vertResolution|0);b+=12;f(a,this.offset+b,0);f(a,this.offset+b+4,this.frameCount<<
16);b+=6;a[this.offset+b]=this.compressorName.length;for(var c=0;31>c;c++)a[this.offset+b+c+1]=c<this.compressorName.length?this.compressorName.charCodeAt(c)&127:0;b+=32;f(a,this.offset+b,this.depth<<16|65535);b+=4;this.otherBoxes&&this.otherBoxes.forEach(function(c){b+=c.write(a)});return b};return c}(l);h.VideoSampleEntry=l;p=function(d){function c(a,b){d.call(this,a);this.data=b}k(c,d);c.prototype.layout=function(a){return this.size=d.prototype.layout.call(this,a)+this.data.length};c.prototype.write=
function(a){var b=d.prototype.write.call(this,a);a.set(this.data,this.offset+b);return b+this.data.length};return c}(p);h.RawTag=p;return h}(),E=function(){function n(e){for(var f=e.length>>1,m=new Uint8Array(f),g=0;g<f;g++)m[g]=parseInt(e.substr(2*g,2),16);return m}var w=["PCM","ADPCM","MP3","PCM le","Nellymouser16","Nellymouser8","Nellymouser","G.711 A-law","G.711 mu-law",null,"AAC","Speex","MP3 8khz"],f;(function(e){e[e.HEADER=0]="HEADER";e[e.RAW=1]="RAW"})(f||(f={}));var r=[null,"JPEG","Sorenson",
"Screen","VP6","VP6 alpha","Screen2","AVC"],k;(function(e){e[e.KEY=1]="KEY";e[e.INNER=2]="INNER";e[e.DISPOSABLE=3]="DISPOSABLE";e[e.GENERATED=4]="GENERATED";e[e.INFO=5]="INFO"})(k||(k={}));var h;(function(e){e[e.HEADER=0]="HEADER";e[e.NALU=1]="NALU";e[e.END=2]="END"})(h||(h={}));var u;(function(e){e[e.CAN_GENERATE_HEADER=0]="CAN_GENERATE_HEADER";e[e.NEED_HEADER_DATA=1]="NEED_HEADER_DATA";e[e.MAIN_PACKETS=2]="MAIN_PACKETS"})(u||(u={}));var q=function(){function p(e){var f=this;this.oncodecinfo=function(e){};
this.ondata=function(e){throw Error("MP4Mux.ondata is not set");};this.metadata=e;this.trackStates=this.metadata.tracks.map(function(e,l){var g={trackId:l+1,trackInfo:e,cachedDuration:0,samplesProcessed:0,initializationData:[]};f.metadata.audioTrackId===l&&(f.audioTrackState=g);f.metadata.videoTrackId===l&&(f.videoTrackState=g);return g},this);this._checkIfNeedHeaderData();this.filePos=0;this.cachedPackets=[];this.chunkIndex=0}p.prototype.pushPacket=function(e,m,g){this.state===u.CAN_GENERATE_HEADER&&
this._tryGenerateHeader();switch(e){case 8:e=this.audioTrackState;var l=0,k=f.RAW,d=m[l],c=d>>4,a=d>>2&3,b=d&2?16:8;d=d&1?2:1;switch(l++,c){case 10:k=m[l++];var n=1024;break;case 2:n=m[l+1]>>3&3;var p=m[l+1]>>1&3;n=1===p?3===n?1152:576:3===p?384:1152}m=info={codecDescription:w[c],codecId:c,data:m.subarray(l),rate:a,size:b,channels:d,samples:n,packetType:k};if(!e||e.trackInfo.codecId!==m.codecId)throw Error("Unexpected audio packet codec: "+m.codecDescription);switch(m.codecId){default:throw Error("Unsupported audio codec: "+
m.codecDescription);case 2:break;case 10:if(m.packetType===f.HEADER){e.initializationData.push(m.data);return}}this.cachedPackets.push({packet:m,timestamp:g,trackId:e.trackId});break;case 9:e=this.videoTrackState;l=0;c=m[l]>>4;k=m[l]&15;l++;c={frameType:c,codecId:k,codecDescription:r[k]};switch(k){case 7:k=m[l++];c.packetType=k;c.compositionTime=(m[l]<<24|m[l+1]<<16|m[l+2]<<8)>>8;l+=3;break;case 4:c.packetType=h.NALU,c.horizontalOffset=m[l]>>4&15,c.verticalOffset=m[l]&15,c.compositionTime=0,l++}c.data=
m.subarray(l);if(!e||e.trackInfo.codecId!==c.codecId)throw Error("Unexpected video packet codec: "+c.codecDescription);switch(c.codecId){default:throw Error("unsupported video codec: "+c.codecDescription);case 4:break;case 7:if(c.packetType===h.HEADER){e.initializationData.push(c.data);return}}this.cachedPackets.push({packet:c,timestamp:g,trackId:e.trackId});break;default:throw Error("unknown packet type: "+e);}this.state===u.NEED_HEADER_DATA&&this._tryGenerateHeader()};p.prototype.flush=function(e){0<
this.cachedPackets.length&&this._chunk();if(e)for(e=0;e<this.trackStates.length;e++)this.trackStates[e].cachedDuration=0};p.prototype._checkIfNeedHeaderData=function(){this.trackStates.some(function(e){return 10===e.trackInfo.codecId||7===e.trackInfo.codecId})?this.state=u.NEED_HEADER_DATA:this.state=u.CAN_GENERATE_HEADER};p.prototype._tryGenerateHeader=function(){if(this.trackStates.every(function(a){switch(a.trackInfo.codecId){case 10:case 7:return 0<a.initializationData.length;default:return!0}})){for(var f=
["isom"],m=[],g=0;g<this.trackStates.length;g++){var k=this.trackStates[g],h=k.trackInfo;switch(h.codecId){case 10:var d=k.initializationData[0];var c=new e.AudioSampleEntry("mp4a",1,h.channels,h.samplesize,h.samplerate);var a=new Uint8Array(41+d.length);a.set(n("0000000003808080"),0);a[8]=32+d.length;a.set(n("00020004808080"),9);a[16]=18+d.length;a.set(n("40150000000000FA000000000005808080"),17);a[34]=d.length;a.set(d,35);a.set(n("068080800102"),35+d.length);c.otherBoxes=[new e.RawTag("esds",a)];
k.mimeTypeCodec="mp4a.40."+(d[0]>>3);break;case 2:c=new e.AudioSampleEntry(".mp3",1,h.channels,h.samplesize,h.samplerate);k.mimeTypeCodec="mp3";break;case 7:d=k.initializationData[0];c=new e.VideoSampleEntry("avc1",1,h.width,h.height);c.otherBoxes=[new e.RawTag("avcC",d)];k.mimeTypeCodec="avc1."+(16777216|d[1]<<16|d[2]<<8|d[3]).toString(16).substr(1);f.push("iso2","avc1","mp41");break;case 4:c=new e.VideoSampleEntry("VP6F",1,h.width,h.height);c.otherBoxes=[new e.RawTag("glbl",n("00"))];k.mimeTypeCodec=
"avc1.42001E";break;default:throw Error("not supported track type");}var b;d=e.TrackHeaderFlags.TRACK_ENABLED|e.TrackHeaderFlags.TRACK_IN_MOVIE;k===this.audioTrackState?b=new e.TrackBox(new e.TrackHeaderBox(d,k.trackId,-1,0,0,1,g),new e.MediaBox(new e.MediaHeaderBox(h.timescale,-1,h.language),new e.HandlerBox("soun","SoundHandler"),new e.MediaInformationBox(new e.SoundMediaHeaderBox,new e.DataInformationBox(new e.DataReferenceBox([new e.DataEntryUrlBox(e.SELF_CONTAINED_DATA_REFERENCE_FLAG)])),new e.SampleTableBox(new e.SampleDescriptionBox([c]),
new e.RawTag("stts",n("0000000000000000")),new e.RawTag("stsc",n("0000000000000000")),new e.RawTag("stsz",n("000000000000000000000000")),new e.RawTag("stco",n("0000000000000000")))))):k===this.videoTrackState&&(b=new e.TrackBox(new e.TrackHeaderBox(d,k.trackId,-1,h.width,h.height,0,g),new e.MediaBox(new e.MediaHeaderBox(h.timescale,-1,h.language),new e.HandlerBox("vide","VideoHandler"),new e.MediaInformationBox(new e.VideoMediaHeaderBox,new e.DataInformationBox(new e.DataReferenceBox([new e.DataEntryUrlBox(e.SELF_CONTAINED_DATA_REFERENCE_FLAG)])),
new e.SampleTableBox(new e.SampleDescriptionBox([c]),new e.RawTag("stts",n("0000000000000000")),new e.RawTag("stsc",n("0000000000000000")),new e.RawTag("stsz",n("000000000000000000000000")),new e.RawTag("stco",n("0000000000000000")))))));m.push(b)}g=new e.MovieExtendsBox(null,[new e.TrackExtendsBox(1,1,0,0,0),new e.TrackExtendsBox(2,1,0,0,0)],null);k=new e.BoxContainerBox("udat",[new e.MetaBox(new e.RawTag("hdlr",n("00000000000000006D6469726170706C000000000000000000")),[new e.RawTag("ilst",n("00000025A9746F6F0000001D6461746100000001000000004C61766635342E36332E313034"))])]);
h=new e.MovieHeaderBox(1E3,0,this.trackStates.length+1);m=new e.MovieBox(h,m,g,k);f=new e.FileTypeBox("isom",512,f);g=f.layout(0);k=m.layout(g);g=new Uint8Array(g+k);f.write(g);m.write(g);this.oncodecinfo(this.trackStates.map(function(a){return a.mimeTypeCodec}));this.ondata(g);this.filePos+=g.length;this.state=u.MAIN_PACKETS}};p.prototype._chunk=function(){var f=this.cachedPackets;if(this.videoTrackState){for(var h=f.length-1,g=this.videoTrackState.trackId;0<h&&(f[h].trackId!==g||f[h].packet.frameType!==
k.KEY);)h--;0<h&&(f=f.slice(0,h))}if(0!==f.length){var n=[],p=0;g=[];for(var d=[],c=0;c<this.trackStates.length;c++){var a=this.trackStates[c],b=a.trackInfo,r=a.trackId,q=f.filter(function(a){return a.trackId===r});if(0!==q.length){var u=new e.TrackFragmentBaseMediaDecodeTimeBox(a.cachedDuration);d.push(p);switch(b.codecId){case 10:case 2:var y=[];for(h=0;h<q.length;h++){var x=q[h].packet,w=Math.round(x.samples*b.timescale/b.samplerate);n.push(x.data);p+=x.data.length;y.push({duration:w,size:x.data.length});
a.samplesProcessed+=x.samples}h=e.TrackFragmentFlags.DEFAULT_SAMPLE_FLAGS_PRESENT;h=new e.TrackFragmentHeaderBox(h,r,0,0,0,0,e.SampleFlags.SAMPLE_DEPENDS_ON_NO_OTHERS);q=e.TrackRunFlags.DATA_OFFSET_PRESENT|e.TrackRunFlags.SAMPLE_DURATION_PRESENT|e.TrackRunFlags.SAMPLE_SIZE_PRESENT;y=new e.TrackRunBox(q,y,0,0);a.cachedDuration=Math.round(a.samplesProcessed*b.timescale/b.samplerate);break;case 7:case 4:y=[];x=a.samplesProcessed;w=Math.round(x*b.timescale/b.framerate);for(h=0;h<q.length;h++){var A=q[h].packet;
x++;var z=Math.round(x*b.timescale/b.framerate),B=z-w;w=z;var C=Math.round(x*b.timescale/b.framerate+A.compositionTime*b.timescale/1E3);n.push(A.data);p+=A.data.length;y.push({duration:B,size:A.data.length,flags:A.frameType===k.KEY?e.SampleFlags.SAMPLE_DEPENDS_ON_NO_OTHERS:e.SampleFlags.SAMPLE_DEPENDS_ON_OTHER|e.SampleFlags.SAMPLE_IS_NOT_SYNC,compositionTimeOffset:C-z})}h=e.TrackFragmentFlags.DEFAULT_SAMPLE_FLAGS_PRESENT;h=new e.TrackFragmentHeaderBox(h,r,0,0,0,0,e.SampleFlags.SAMPLE_DEPENDS_ON_NO_OTHERS);
q=e.TrackRunFlags.DATA_OFFSET_PRESENT|e.TrackRunFlags.SAMPLE_DURATION_PRESENT|e.TrackRunFlags.SAMPLE_SIZE_PRESENT|e.TrackRunFlags.SAMPLE_FLAGS_PRESENT|e.TrackRunFlags.SAMPLE_COMPOSITION_TIME_OFFSET;y=new e.TrackRunBox(q,y,0,0);a.cachedDuration=w;a.samplesProcessed=x;break;default:throw Error("Un codec");}a=new e.TrackFragmentBox(h,u,y);g.push(a)}}this.cachedPackets.splice(0,f.length);c=new e.MovieFragmentHeaderBox(++this.chunkIndex);f=new e.MovieFragmentBox(c,g);p=f.layout(0);n=new e.MediaDataBox(n);
a=n.layout(p);b=p+8;for(c=0;c<g.length;c++)g[c].run.dataOffset=b+d[c];g=new Uint8Array(p+a);f.write(g);n.write(g);this.ondata(g);this.filePos+=g.length}};return p}();q.MP3_SOUND_CODEC_ID=2;q.AAC_SOUND_CODEC_ID=10;q.TYPE_AUDIO_PACKET=8;q.TYPE_VIDEO_PACKET=9;q.Profiles={MP3_AUDIO_ONLY:{audioTrackId:0,videoTrackId:-1,tracks:[{codecId:q.MP3_SOUND_CODEC_ID,channels:2,samplerate:44100,samplesize:16,timescale:44100}]}};return q}();z.MP3Parser=D;z.MP4Mux=E;z.MP4Iso=e})(window);